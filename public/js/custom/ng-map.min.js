var ngMap=angular.module("ngMap",[]);ngMap.directive("infoWindow",["Attr2Options",function(Attr2Options){var parser=new Attr2Options;return{restrict:"E",require:"^map",link:function(scope,element,attrs,mapController){var filtered=new parser.filter(attrs);scope.google=google;var options=parser.getOptions(filtered,scope);options.pixelOffset&&(options.pixelOffset=google.maps.Size.apply(this,options.pixelOffset));var infoWindow=new google.maps.InfoWindow(options);infoWindow.contents=element.html();var events=parser.getEvents(scope,filtered);for(var eventName in events)eventName&&google.maps.event.addListener(infoWindow,eventName,events[eventName]);mapController.infoWindows.push(infoWindow),element.css({display:"none"}),scope.showInfoWindow=function(event,id,options){var infoWindow=scope.infoWindows[id],contents=infoWindow.contents,matches=contents.match(/\[\[[^\]]+\]\]/g);if(matches)for(var i=0,length=matches.length;length>i;i++){var expression=matches[i].replace(/\[\[/,"").replace(/\]\]/,"");try{contents=contents.replace(matches[i],eval(expression))}catch(e){expression="options."+expression,contents=contents.replace(matches[i],eval(expression))}}infoWindow.setContent(contents),infoWindow.open(scope.map,this)}}}}]),ngMap.directive("map",["Attr2Options","$parse","NavigatorGeolocation","GeoCoder","$compile",function(e,t,n,o){var r=new e;return{restrict:"AE",controller:["$scope",function(e){this.map=null,this.controls={},this.markers=[],this.shapes=[],this.infoWindows=[],this.initializeMap=function(e,t,i){var a=r.filter(i);e.google=google;var s=r.getOptions(a,e),c=r.getControlOptions(a);for(var p in c)p&&(s[p]=c[p]);var l=this,g=null;if(s.zoom||(s.zoom=15),s.center instanceof Array){var v=s.center[0],f=s.center[1];s.center=new google.maps.LatLng(v,f)}else g=s.center,delete s.center;for(var u in this.controls)u&&(s[u+"Control"]="false"===this.controls[u].enabled?0:1,delete this.controls[u].enabled,s[u+"ControlOptions"]=this.controls[u]);var m=document.createElement("div");m.style.width="100%",m.style.height="100%",t.prepend(m),l.map=new google.maps.Map(m,s),"string"==typeof g?o.geocode({address:g}).then(function(e){l.map.setCenter(e[0].geometry.location)}):s.center||n.getCurrentPosition().then(function(e){var t=e.coords.latitude,n=e.coords.longitude;l.map.setCenter(new google.maps.LatLng(t,n))});var d=r.getEvents(e,a);for(var h in d)h&&google.maps.event.addListener(l.map,h,d[h]);return e.map=l.map,l.map},this.addMarker=function(t){t.setMap(this.map),t.centered&&this.map.setCenter(t.position);var n=Object.keys(e.markers).length;e.markers[t.id||n]=t},this.initializeMarkers=function(){e.markers={};for(var t=0;t<this.markers.length;t++){var n=this.markers[t];this.addMarker(n)}return e.markers},this.initializeShapes=function(){e.shapes={};for(var t=0;t<this.shapes.length;t++){var n=this.shapes[t];n.setMap(this.map),e.shapes[n.id||t+1]=n}return e.shapes},this.initializeInfoWindows=function(){e.infoWindows={};for(var t=0;t<this.infoWindows.length;t++){var n=this.infoWindows[t];e.infoWindows[n.id||t+1]=n}return e.infoWindows}}],link:function(e,t,n,o){var r=o.initializeMap(e,t,n);e.$emit("mapInitialized",[r]);var i=o.initializeMarkers();e.$emit("markersInitialized",[i]);var a=o.initializeShapes();e.$emit("shapesInitialized",[a]);var s=o.initializeInfoWindows();e.$emit("infoWindowsInitialized",[s])}}}]),ngMap.directive("marker",["Attr2Options","GeoCoder","NavigatorGeolocation",function(e,t,n){var o=new e;return{restrict:"E",require:"^map",link:function(e,r,i,a){var s=new o.filter(i);e.google=google;var c=o.getOptions(s,e),p=o.getEvents(e,s),l=function(){var e=new google.maps.Marker(c);Object.keys(p).length>0;for(var t in p)t&&google.maps.event.addListener(e,t,p[t]);return e};if(c.position instanceof Array){var g=c.position[0],v=c.position[1];c.position=new google.maps.LatLng(g,v);var f=l();c.ngRepeat?a.addMarker(f):a.markers.push(f)}else if("string"==typeof c.position){var u=c.position;u.match(/^current/i)?n.getCurrentPosition().then(function(e){var t=e.coords.latitude,n=e.coords.longitude;c.position=new google.maps.LatLng(t,n);var o=l();a.addMarker(o)}):t.geocode({address:c.position}).then(function(e){var t=e[0].geometry.location;c.position=t;var n=l();a.addMarker(n)})}}}}]),ngMap.directive("shape",["Attr2Options",function(e){var t=new e,n=function(e){return e[0]&&e[0]instanceof Array?e.map(function(e){return new google.maps.LatLng(e[0],e[1])}):new google.maps.LatLng(e[0],e[1])},o=function(e){var t=n(e);return new google.maps.LatLngBounds(t[0],t[1])},r=function(e,t){switch(e){case"circle":return t.center=n(t.center),new google.maps.Circle(t);case"polygon":return t.paths=n(t.paths),new google.maps.Polygon(t);case"polyline":return t.path=n(t.path),new google.maps.Polyline(t);case"rectangle":return t.bounds=o(t.bounds),new google.maps.Rectangle(t);case"groundOverlay":case"image":var r=t.url,i=o(t.bounds),a={opacity:t.opacity,clickable:t.clickable};return new google.maps.GroundOverlay(r,i,a)}return null};return{restrict:"E",require:"^map",link:function(e,n,o,i){var a=t.filter(o),s=a.name;delete a.name;var c=t.getOptions(a),p=r(s,c);p&&i.shapes.push(p);var l=t.getEvents(e,a);for(var g in l)l[g]&&google.maps.event.addListener(p,g,l[g])}}}]),ngMap.provider("Attr2Options",function(){this.$get=function(){return function(){this.filter=function(e){var t={};for(var n in e)n.match(/^\$/)||(t[n]=e[n]);return t},this.getOptions=function(attrs,scope){var options={};for(var key in attrs)if(attrs[key]){if(key.match(/^on[A-Z]/))continue;if(key.match(/ControlOptions$/))continue;var val=attrs[key];try{var num=Number(val);if(isNaN(num))throw"Not a number";options[key]=num}catch(err){try{options[key]=JSON.parse(val)}catch(err2){if(val.match(/^[A-Z][a-zA-Z0-9]+\(.*\)$/))try{var exp="new google.maps."+val;options[key]=eval(exp)}catch(e){options[key]=val}else if(val.match(/^[A-Z][a-zA-Z0-9]+\.[A-Z]+$/))try{options[key]=scope.$eval("google.maps."+val)}catch(e){options[key]=val}else if(val.match(/^[A-Z]+$/))try{var capitializedKey=key.charAt(0).toUpperCase()+key.slice(1);options[key]=scope.$eval("google.maps."+capitializedKey+"."+val)}catch(e){options[key]=val}else options[key]=val}}}return options},this.getEvents=function(e,t){var n={},o=function(e){return"_"+e.toLowerCase()},r=function(t){var n=t.match(/([^\(]+)\(([^\)]*)\)/),o=n[1],r=n[2].replace(/event[ ,]*/,""),i=e.$eval("["+r+"]");return function(t){e[o].apply(this,[t].concat(i))}};for(var i in t)if(t[i]){if(!i.match(/^on[A-Z]/))continue;var a=i.replace(/^on/,"");a=a.charAt(0).toLowerCase()+a.slice(1),a=a.replace(/([A-Z])/g,o);var s=t[i];n[a]=new r(s)}return n},this.getControlOptions=function(e){var t={};for(var n in e)if(e[n]){if(!n.match(/(.*)ControlOptions$/))continue;var o=e[n],r=o.replace(/'/g,'"');r=r.replace(/([^"]+)|("[^"]+")/g,function(e,t,n){return t?t.replace(/([a-zA-Z0-9]+?):/g,'"$1":'):n});try{var i=JSON.parse(r);for(var a in i)if(i[a]){var s=i[a];if("string"==typeof s?s=s.toUpperCase():"mapTypeIds"===a&&(s=s.map(function(e){return google.maps.MapTypeId[e.toUpperCase()]})),"style"===a){var c=n.charAt(0).toUpperCase()+n.slice(1),p=c.replace(/Options$/,"")+"Style";i[a]=google.maps[p][s]}else i[a]="position"===a?google.maps.ControlPosition[s]:s}t[n]=i}catch(l){}}return t}}}}),ngMap.service("GeoCoder",["$q",function(e){return{geocode:function(t){var n=e.defer(),o=new google.maps.Geocoder;return o.geocode(t,function(e,t){t==google.maps.GeocoderStatus.OK?n.resolve(e):n.reject("Geocoder failed due to: "+t)}),n.promise}}}]),ngMap.service("NavigatorGeolocation",["$q",function(e){return{getCurrentPosition:function(){var t=e.defer();return navigator.geolocation?navigator.geolocation.getCurrentPosition(function(e){t.resolve(e)},function(e){t.reject(e)}):t.reject("Browser Geolocation service failed."),t.promise},watchPosition:function(){return"TODO"},clearWatch:function(){return"TODO"}}}]);